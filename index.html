<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Japanese Reader & SRS</title>
    <link rel="stylesheet" href="styles.css">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4A90E2">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://via.placeholder.com/192/4A90E2/ffffff?text=JP">
    <!-- JSZip for export/import functionality -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>

    <main id="app-container">

        <section id="view-story" class="view active">
            <header>
                <h2>Story Reader</h2>
            </header>
            <div id="story-content" class="content-scroll">
                <div class="placeholder-text">Loading story...</div>
            </div>
        </section>

        <section id="view-srs" class="view">
            <header style="display: flex; justify-content: space-between; align-items: center;">
                <h2>Review</h2>
                <span id="srs-counter" style="font-size: 14px; color: var(--text-muted);">0 Due</span>
            </header>
            <div id="srs-content" class="content-scroll flex-center" style="background-color: #eef2f5; position: relative; overflow: hidden;">
                <div id="flashcard-container" style="width: 100%; max-width: 350px; position: relative; height: 400px; display: none;">
                    <div id="flashcard" class="flashcard">
                        <div class="flashcard-face flashcard-front flex-center flex-column">
                            <span id="fc-furi" style="font-size: 18px; color: var(--text-muted); margin-bottom: 5px; height: 27px;"></span>
                            <h1 id="fc-word" style="font-size: 42px; margin: 0;"></h1>
                            <p style="margin-top: 30px; color: var(--text-muted); font-size: 14px;">Tap to reveal</p>
                        </div>
                        <div class="flashcard-face flashcard-back flex-center flex-column">
                            <h2 id="fc-word-back" style="font-size: 32px; margin-bottom: 5px;"></h2>
                            <h3 id="fc-trans" style="font-size: 24px; color: var(--primary-color); margin-bottom: 20px;"></h3>
                            <div style="width: 100%; padding: 0 20px;">
                                <p style="font-size: 14px; color: var(--text-muted); margin-bottom: 5px;">Current Status:</p>
                                <div class="status-buttons" id="fc-status-group" style="margin-bottom: 30px;">
                                    <button class="status-btn fc-btn" data-status="0">0</button>
                                    <button class="status-btn fc-btn" data-status="1">1</button>
                                    <button class="status-btn fc-btn" data-status="2">2</button>
                                    <button class="status-btn fc-btn" data-status="3">3</button>
                                    <button class="status-btn fc-btn" data-status="4">4</button>
                                    <button class="status-btn fc-btn" data-status="5">5</button>
                                </div>
                            </div>
                            <p style="font-size: 14px; color: var(--text-muted);">
                                &larr; Swipe Left to Decrease <br>
                                Swipe Right to Increase &rarr;
                            </p>
                        </div>
                    </div>
                </div>
                <div id="srs-empty-state" class="placeholder-text">
                    <h3>All caught up!</h3>
                    <p style="margin-top: 10px;">Read more stories to add words to your review queue.</p>
                </div>
            </div>
        </section>

        <section id="view-vocab" class="view">
            <header>
                <h2>Vocabulary</h2>
            </header>
            <div class="vocab-controls" style="padding: 10px 20px; background: var(--surface-color); border-bottom: 1px solid var(--border-color);">
                <input type="text" id="vocab-search" placeholder="Search Japanese or English..." style="margin-bottom: 10px;">
                <div style="display: flex; gap: 10px;">
                    <select id="vocab-filter" style="flex: 1;">
                        <option value="all">All Statuses</option>
                        <option value="0">Status 0 (Unknown)</option>
                        <option value="1">Status 1</option>
                        <option value="2">Status 2</option>
                        <option value="3">Status 3</option>
                        <option value="4">Status 4</option>
                        <option value="5">Status 5 (Known)</option>
                    </select>
                    <select id="vocab-sort" style="flex: 1;">
                        <option value="newest">Newest First</option>
                        <option value="oldest">Oldest First</option>
                        <option value="az">A-Z (Japanese)</option>
                        <option value="status_asc">Status (Low to High)</option>
                        <option value="status_desc">Status (High to Low)</option>
                    </select>
                </div>
                <div style="margin-top: 5px; font-size: 12px; color: var(--text-muted); text-align: right;">
                    <span id="vocab-count">0</span> words found
                </div>
            </div>
            <div id="vocab-list" class="content-scroll"></div>
        </section>

        <section id="view-settings" class="view">
            <header>
                <h2>Settings</h2>
            </header>
            <div id="settings-content" class="content-scroll">

                <div class="settings-group">
                    <div class="settings-group-header">
                        <span class="settings-group-icon">üîë</span>
                        <h3>API & Models</h3>
                    </div>
                    <div class="settings-row settings-row-column">
                        <div class="settings-label-row">
                            <label class="settings-label">Gemini API Keys</label>
                            <button type="button" id="btn-add-api-key" class="btn-add-key">+ Add Key</button>
                        </div>
                        <div id="api-keys-container"></div>
                        <p class="settings-hint" style="padding: 4px 0 0; font-size:11px;">Multiple keys rotate automatically when a key is rate-limited.</p>
                    </div>
                    <div class="settings-row">
                        <label class="settings-label" for="setting-text-model">Text Model</label>
                        <select id="setting-text-model">
                            <option value="gemini-2.5-pro">gemini-2.5-pro (Recommended)</option>
                            <option value="gemini-2.5-flash">gemini-2.5-flash</option>
                            <option value="gemini-2.5-flash-lite">gemini-2.5-flash-lite</option>
                            <option value="gemini-2.0-flash">gemini-2.0-flash</option>
                            <option value="gemini-flash-latest">gemini-flash-latest</option>
                        </select>
                    </div>
                    <div class="settings-row">
                        <label class="settings-label" for="setting-image-model">Image Model</label>
                        <select id="setting-image-model">
                            <option value="gemini-2.0-flash-preview-image-generation">gemini-2.0-flash-preview-image-generation</option>
                        </select>
                    </div>
                    <div class="settings-row">
                        <label class="settings-label" for="setting-timeout">Request Timeout (s)</label>
                        <input type="number" id="setting-timeout" min="10" max="600" value="120" class="settings-input-short">
                    </div>
                    <div class="settings-divider"></div>
                    <label class="settings-toggle">
                        <input type="checkbox" id="setting-generate-images">
                        <span class="settings-toggle-track"></span>
                        <span class="settings-toggle-text">Enable Image Generation <em>(Experimental)</em></span>
                    </label>
                    <label class="settings-toggle">
                        <input type="checkbox" id="setting-use-fallback" checked>
                        <span class="settings-toggle-track"></span>
                        <span class="settings-toggle-text">Auto-fallback to next model on rate limit</span>
                    </label>
                </div>

                <div class="settings-group">
                    <div class="settings-group-header">
                        <span class="settings-group-icon">üìñ</span>
                        <h3>Reader</h3>
                    </div>
                    <div class="settings-row">
                        <label class="settings-label" for="setting-highlight-style">Highlight Style</label>
                        <select id="setting-highlight-style">
                            <option value="background">Background Color</option>
                            <option value="text">Text Color</option>
                        </select>
                    </div>
                    <div class="settings-row">
                        <label class="settings-label" for="setting-srs-mode">SRS Story Mode</label>
                        <select id="setting-srs-mode">
                            <option value="mix">Mix (Latest + Needs Review)</option>
                            <option value="new">Focus New Words</option>
                            <option value="none">Disabled</option>
                        </select>
                    </div>
                    <div class="settings-divider"></div>
                    <label class="settings-toggle">
                        <input type="checkbox" id="setting-show-furigana" checked>
                        <span class="settings-toggle-track"></span>
                        <span class="settings-toggle-text">Show Furigana</span>
                    </label>
                    <label class="settings-toggle">
                        <input type="checkbox" id="setting-show-romaji">
                        <span class="settings-toggle-track"></span>
                        <span class="settings-toggle-text">Show Romaji</span>
                    </label>
                    <label class="settings-toggle">
                        <input type="checkbox" id="setting-sentence-newline">
                        <span class="settings-toggle-track"></span>
                        <span class="settings-toggle-text">Start each sentence on a new line</span>
                    </label>
                    <label class="settings-toggle">
                        <input type="checkbox" id="setting-sentence-parsing" checked>
                        <span class="settings-toggle-track"></span>
                        <span class="settings-toggle-text">Enable Sentence Translation <em>(extra API call)</em></span>
                    </label>
                </div>

                <div class="settings-group">
                    <div class="settings-group-header">
                        <span class="settings-group-icon">üéì</span>
                        <h3>Word Trainer</h3>
                    </div>
                    <div class="settings-row">
                        <label class="settings-label" for="trainer-srs-mode">SRS word colours</label>
                        <select id="trainer-srs-mode">
                            <option value="use">Apply (same as Reader)</option>
                            <option value="ignore">Ignore (treat all as unrated)</option>
                        </select>
                    </div>
                    <div class="settings-row">
                        <label class="settings-label" for="trainer-ext-mode">Unknown word display</label>
                        <select id="trainer-ext-mode">
                            <option value="highlight">Highlight in blue</option>
                            <option value="replace_furi">Show translation as furigana</option>
                            <option value="replace_word">Replace word with translation</option>
                        </select>
                    </div>
                    <p class="settings-hint">Controls how words outside the current rank range (e.g. word #52+ when training word #51) are shown in trainer sentences.</p>
                </div>

                <div class="settings-group">
                    <div class="settings-group-header">
                        <span class="settings-group-icon">üõ†Ô∏è</span>
                        <h3>Developer</h3>
                    </div>
                    <label class="settings-toggle">
                        <input type="checkbox" id="setting-debug-mode">
                        <span class="settings-toggle-track"></span>
                        <span class="settings-toggle-text">Debug Mode <em>(logs to console)</em></span>
                    </label>
                </div>

                <button id="btn-save-settings" class="primary-btn" style="margin-bottom: 30px;">üíæ Save Settings</button>

            </div>
        </section>

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <!-- DATA TAB                                               -->
        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <section id="view-data" class="view">
            <header>
                <h2>Data</h2>
            </header>
            <div class="content-scroll" id="data-content">

                <!-- ‚îÄ‚îÄ EXPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
                <div class="data-panel">
                    <div class="data-panel-header">
                        <span class="data-panel-icon">üì¶</span>
                        <div>
                            <h3>Export Stories</h3>
                            <p class="data-panel-sub">Save stories to a .zip file on your device.</p>
                        </div>
                    </div>

                    <div class="story-select-toolbar">
                        <button class="text-btn" id="btn-select-all">Select All</button>
                        <span class="toolbar-sep">¬∑</span>
                        <button class="text-btn" id="btn-select-none">Select None</button>
                    </div>

                    <div id="export-story-list" class="story-select-list">
                        <p class="placeholder-text" style="margin:10px 0;">No stories saved yet.</p>
                    </div>

                    <label class="checkbox-label" style="margin-top:12px;">
                        <input type="checkbox" id="export-include-vocab">
                        Also export my vocabulary / SRS data
                    </label>

                    <button class="primary-btn" style="margin-top:14px;" id="btn-download-zip">
                        ‚¨á Download as .zip
                    </button>
                    <div id="export-status" class="status-message" style="display:none;"></div>
                </div>

                <!-- ‚îÄ‚îÄ IMPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
                <div class="data-panel">
                    <div class="data-panel-header">
                        <span class="data-panel-icon">üìÇ</span>
                        <div>
                            <h3>Import Stories</h3>
                            <p class="data-panel-sub">Load a previously exported .zip. Duplicate stories are skipped.</p>
                        </div>
                    </div>

                    <label class="file-pick-label">
                        <input type="file" id="data-import-file" accept=".zip" style="display:none;">
                        <span class="file-pick-btn">Choose .zip file</span>
                        <span id="import-filename" class="file-pick-name">No file chosen</span>
                    </label>

                    <button id="btn-confirm-import" class="primary-btn" style="display:none; margin-top:12px;">
                        ‚¨Ü Import Now
                    </button>
                    <div id="import-status" class="status-message" style="display:none;"></div>
                </div>

                <!-- ‚îÄ‚îÄ SYNC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
                <div class="data-panel">
                    <div class="data-panel-header">
                        <span class="data-panel-icon">üîÑ</span>
                        <div>
                            <h3>Sync from URL</h3>
                            <p class="data-panel-sub">Pull a shared .zip from a direct link.</p>
                        </div>
                    </div>

                    <label style="font-size:14px; font-weight:500; margin-bottom:6px; display:block;">Sync URL</label>
                    <input type="url" id="data-sync-url"
                           placeholder="https://your-host.com/shared-stories.zip"
                           style="margin-bottom:8px;">
                    <button class="primary-btn sync-btn" id="btn-sync-now">
                        üîÑ Sync Now
                    </button>
                    <div id="sync-status" class="status-message" style="display:none;"></div>
                </div>

            </div>
        </section>

        <section id="view-trainer" class="view">
            <header>
                <h2>Word Trainer</h2>
            </header>
            <div id="trainer-progress-container">
                <div style="display:flex; justify-content:space-between; align-items:center; padding: 6px 20px 4px; font-size:13px; color:var(--text-muted);">
                    <span id="trainer-progress-label">Word 1 / 1000</span>
                    <div id="trainer-pregen-box" class="hidden" style="position:static; box-shadow:none; padding:0; background:transparent; font-size:12px; display:none; align-items:center; gap:6px;">
                        Next: <span id="pregen-word" style="font-weight:bold;"></span>
                        <button id="btn-pregen">Pre-generate</button>
                    </div>
                </div>
                <div style="height:8px; background:#e0e0e0; margin: 0 20px 8px; border-radius:4px; overflow:hidden;">
                    <div id="trainer-progress-fill" style="height:100%; background:var(--primary-color); border-radius:4px; width:0%; transition:width 0.3s;"></div>
                </div>
            </div>
            <div id="trainer-content" class="content-scroll"></div>
        </section>

        <section id="view-games" class="view">
            <header><h2 id="games-header-title">Mini Games</h2></header>
            <div id="games-list-screen"  class="content-scroll"></div>
            <div id="caro-setup-screen"  class="content-scroll" style="display:none;"></div>
            <div id="caro-game-screen"   class="content-scroll" style="display:none; background:#eef2f5;"></div>
            <div id="caro-stats-screen"  class="content-scroll" style="display:none;"></div>
        </section>

    </main>

    <nav id="bottom-nav">
        <button class="nav-btn active" data-target="view-story">Story</button>
        <button class="nav-btn" data-target="view-srs">SRS</button>
        <button class="nav-btn" data-target="view-vocab">List</button>
        <button class="nav-btn" data-target="view-data">Data</button>
        <button class="nav-btn" data-target="view-trainer">Train</button>
        <button class="nav-btn" data-target="view-games">Games</button>
        <button class="nav-btn" data-target="view-settings">Settings</button>
    </nav>

    <div id="word-popup-overlay" class="hidden">
        <div id="word-popup" class="popup-card">
            <div class="popup-header">
                <h3 id="popup-term">...</h3>
                <span id="popup-furi" style="color:var(--text-muted); font-size:14px;">...</span>
                <span id="popup-roma" style="color:var(--primary-color); font-size:12px; font-style:italic; margin-left:6px; display:none;">...</span>
            </div>
            <div class="popup-body">
                <p><strong>Base:</strong> <span id="popup-base">...</span></p>
                <p><strong>Meaning (Base):</strong> <span id="popup-trans-base">...</span></p>
                <p><strong>Meaning (Context):</strong> <span id="popup-trans-context">...</span></p>
                <p class="popup-note" id="popup-note">...</p>
            </div>
            <div class="popup-footer">
                <p>Known Status:</p>
                <div class="status-buttons" id="popup-status-group">
                    <button class="status-btn" data-status="0">0</button>
                    <button class="status-btn" data-status="1">1</button>
                    <button class="status-btn" data-status="2">2</button>
                    <button class="status-btn" data-status="3">3</button>
                    <button class="status-btn" data-status="4">4</button>
                    <button class="status-btn" data-status="5">5</button>
                </div>
            </div>
            <button id="close-popup-btn" style="margin-top: 15px;">Close</button>

            <!-- Trainer zone (shown only when opened from Trainer tab) -->
            <div id="popup-trainer-zone" class="hidden" style="background:#eef2f5; padding:10px; margin-top:10px; border-radius:6px;">
                <p style="margin:0 0 8px; font-size:14px;">List Rank: #<span id="popup-rank">...</span></p>
                <button id="btn-trainer-jump" class="primary-btn" style="width:100%; padding:8px;">Jump to this word</button>
            </div>
        </div>
    </div>

    <script type="module" src="js/app.js"></script>
</body>
</html>